function loadjs(fileName,callBack){var el_script=document.createElement("script");el_script.type="text/javascript",el_script.src=fileName,el_script.onload=callBack,document.body.appendChild(el_script)}function LoadOperationFromObject(){var category=_operation.category,subcategory=_operation.subcategory;if(void 0===_categories[category.name]){_categories[category.name]={title:category.title,subcategories:{}};var el_category_option=document.createElement("option");el_category_option.text=category.title.en,el_category_option.value=category.name,_el_categories.appendChild(el_category_option)}void 0===_categories[category.name].subcategories[subcategory.name]&&(_categories[category.name].subcategories[subcategory.name]={title:subcategory.title,operations:{}}),_categories[category.name].subcategories[subcategory.name].operations[_operation.name]=_operation}function ParseOperationsList(){for(var strOperationPath in _OperationsPathList){var opFile=_OperationsPathList[strOperationPath];""!==(opFile=opFile.trim())&&".js"===opFile.slice(-3)&&loadjs(opFile,LoadOperationFromObject)}_el_categories.addEventListener("change",RenderSubcategoriesList),_el_subcategories.addEventListener("change",RenderOperationsList),_el_operations.addEventListener("change",RenderOperationForm),_el_load_operation.addEventListener("change",onLoadOperation),_el_load_operation_zone.addEventListener("dragover",onLoadOperationZoneDragOver,!1),_el_load_operation_zone.addEventListener("drop",onLoadOperationZoneFileSelect,!1)}function onLoadOperationZoneFileSelect(evt){var files;evt.stopPropagation(),evt.preventDefault(),onLoadOperation(evt.dataTransfer.files)}function onLoadOperationZoneDragOver(evt){evt.stopPropagation(),evt.preventDefault(),evt.dataTransfer.dropEffect="copy"}function RenderSubcategoriesList(){if(_el_subcategories.innerHTML="",_el_operations.innerHTML="",_el_form.innerHTML="",""!==_el_categories.value){var el_subcategory_option=document.createElement("option");el_subcategory_option.text="Select subcategory...",el_subcategory_option.value="",_el_subcategories.appendChild(el_subcategory_option);var subcategories=_categories[_el_categories.value].subcategories;for(var subcategory_name in subcategories){var subcategory=subcategories[subcategory_name];(el_subcategory_option=document.createElement("option")).text=subcategory.title.en,el_subcategory_option.value=subcategory_name,_el_subcategories.appendChild(el_subcategory_option)}}}function RenderOperationsList(){if(_el_operations.innerHTML="",_el_form.innerHTML="",""!==_el_subcategories.value){var el_operation_option=document.createElement("option");el_operation_option.text="Select operation...",el_operation_option.value="",_el_operations.appendChild(el_operation_option);var subcategories,operations=_categories[_el_categories.value].subcategories[_el_subcategories.value].operations;for(var operation_name in operations){var operation=operations[operation_name];(el_operation_option=document.createElement("option")).text=operation.title.en,el_operation_option.value=operation.name,_el_operations.appendChild(el_operation_option)}}}function RenderOperationForm(){_el_form.innerHTML="";var operation=GetCurrentOperation();if(void 0!==operation){for(var f in operation.fields){var f_name=operation.fields[f].name,f_title=operation.fields[f].title.en,f_type=operation.fields[f].type,f_value=void 0!==operation.fields[f].value?operation.fields[f].value:"",f_attr=operation.fields[f].attributes,el_label=document.createElement("label");el_label.innerText=f_title,_el_form.appendChild(el_label),_el_form.appendChild(document.createElement("br"));var el=null;if("text"===f_type&&((el=document.createElement("input")).type="text",el.value=f_value,_el_form.appendChild(el),_el_form.appendChild(document.createElement("br"))),"textarea"===f_type&&((el=document.createElement("textarea")).value=f_value,_el_form.appendChild(el),_el_form.appendChild(document.createElement("br"))),"file"===f_type&&((el=document.createElement("input")).type="file",_el_form.appendChild(el),_el_form.appendChild(document.createElement("br"))),el&&f_attr&&Array.isArray(f_attr))for(var a in f_attr)el.setAttribute(f_attr[a].name,f_attr[a].value);el.id=el.name=f_name}_el_form.appendChild(document.createElement("hr"));var el_saveZIP=document.createElement("button");el_saveZIP.innerText="Create archive",_el_form.appendChild(el_saveZIP),el_saveZIP.addEventListener("click",SaveOperationFormToZIP);var el_saveOperationTemplate=document.createElement("a");el_saveOperationTemplate.href=_el_operations.options[_el_operations.selectedIndex].text+".js",el_saveOperationTemplate.innerText="Save as a template",el_saveOperationTemplate.addEventListener("click",function(){var operationData=ConvertFormToObject(),operationJson,operationJS="_operation = "+JSON.stringify(operationData,null,2)+";";return this.href="data:application/xml;charset=utf-8,"+operationJS,this.setAttribute("download",operationData.title.en+".js"),!0}),_el_form.appendChild(el_saveOperationTemplate);var el_saveOperationsList=document.createElement("a");el_saveOperationsList.href="list.js",el_saveOperationsList.innerText="Update templates list",el_saveOperationsList.addEventListener("click",function(){var operationData=ConvertFormToObject(),operationJson,operationJS="_operation = "+JSON.stringify(operationData,null,2)+";";return this.href="data:application/xml;charset=utf-8,"+operationJS,this.setAttribute("download","list.js"),!0}),_el_form.appendChild(el_saveOperationsList),_el_form.appendChild(document.createElement("hr"))}}function GetCurrentOperation(){if(""!==_el_categories.value&&""!==_el_subcategories.value&&""!==_el_operations.value){var subcategories,operations;try{operations=(subcategories=_categories[_el_categories.value].subcategories)[_el_subcategories.value].operations}catch(e){return}return operations[_el_operations.value]}}function ConvertFormToObject(){var formData=[],formItem={};for(var e in _zip=new JSZip,_el_form.childNodes){var el=_el_form.childNodes[e];switch(el.localName){case"label":(formItem={}).title={en:el.innerText,ru:el.innerText};break;case"input":switch(formItem.name=el.id,el.type){case"text":formItem.value=el.value,formItem.type="text",formData.push(formItem);break;case"file":formItem.type="file",""===el.getAttribute("multiple")&&(formItem.attributes=[{name:"multiple",value:""}]),formItem.value=[];for(var f=0;f<el.files.length;f++){var file=el.files[f];formItem.value.push({name:file.name,type:file.type,size:file.size}),_zip.file(formItem.name+"/"+file.name,file)}formData.push(formItem)}break;case"textarea":formItem.name=el.id,formItem.value=el.value,formItem.type="textarea",formData.push(formItem)}}var operation=GetCurrentOperation(),operationData;return{version:operation.version,name:_el_operations.value,title:{en:operation.title.en,ru:operation.title.ru},category:{name:_el_categories.value,title:{en:"Applications",ru:"Заявления"}},subcategory:{name:_el_subcategories.value,title:{en:"Admission to party members",ru:"Прием в члены партии"}},fields:formData}}function buf2hex(buffer){return Array.prototype.map.call(new Uint8Array(buffer),function(x){return("00"+x.toString(16)).slice(-2)}).join("")}function _base64ToArrayBuffer(base64){for(var binary_string=window.atob(base64),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return bytes.buffer}function GenerateTSA(digest){var view=new Int8Array(digest),array=Array.prototype.slice.call(view);const detached=OpenTimestamps.DetachedTimestampFile.fromHash(new OpenTimestamps.Ops.OpSHA256,array);OpenTimestamps.stamp(detached).then(()=>{const fileOts=detached.serializeToBytes();console.log(fileOts),saveAs(new Blob([fileOts]),"output.ots");const detached2=OpenTimestamps.DetachedTimestampFile.fromHash(new OpenTimestamps.Ops.OpSHA256,array),detachedOts=OpenTimestamps.DetachedTimestampFile.deserialize(fileOts);OpenTimestamps.verify(detachedOts,detached2).then(verifyResult=>{console.log(verifyResult)})});var json={mi:{hashAlg:"sha256",hashValue:"9834876dcfb05cb167a5c24953eba58c4ac89b1adf57f28f2f9d09af107ee8f0"},certreq:!0},o,hex=new KJUR.asn1.tsp.TimeStampReq(json).getEncodedHex(),b64=hex2b64(hex);testB64=b64,digest=_base64ToArrayBuffer(testB64);var xhr=new XMLHttpRequest;xhr.onerror=function(e){console.log(e)},xhr.upload.addEventListener("progress",function(e){console.log(e.loaded+"/"+e.total)},!1),xhr.onreadystatechange=function(){xhr.readyState===XMLHttpRequest.DONE&&(xhr.status>=200&&xhr.status<=299?saveAs(xhr.response,"output.tsr"):alert(xhr.status))},xhr.open("POST","https://freetsa.org/tsr",!0),xhr.setRequestHeader("Content-Type","application/timestamp-query"),xhr.responseType="blob",xhr.send(digest)}function SaveOperationFormToZIP(){var operationData=ConvertFormToObject();console.log(operationData);var operationJson=JSON.stringify(operationData,null,2);_zip.file("operation.json",operationJson),_zip.generateAsync({type:"arraybuffer"}).then(function(content){var blob=new Blob([new Uint8Array(content)]);window.crypto.subtle.digest("SHA-256",content).then(function(digest){console.log(buf2hex(digest)),GenerateTSA(digest)},function(error){console.error("Error",error)})})}function UpdateOperationForm(fRenderForm){LoadOperationFromObject(),fRenderForm&&(_el_categories.value=_operation.category.name,RenderSubcategoriesList(),_el_subcategories.value=_operation.subcategory.name,RenderOperationsList(),_el_operations.value=_operation.name,RenderOperationForm())}function onLoadOperation(files){void 0===files.length&&(files=_el_load_operation.files);for(var f=0;f<files.length;f++){var file=files[f],fileExt=file.name.split(".").pop();if("zip"===fileExt)JSZip.loadAsync(file).then(function(zip){zip.forEach(function(relativePath,zipEntry){"operation.json"==zipEntry.name&&zipEntry.async("string").then(function success(text){_operation=JSON.parse(text),UpdateOperationForm(1==files.length)},function error(e){console.error("Error: ",e)})})},function(e){});else if("js"===fileExt||"json"===fileExt){var reader=new FileReader;reader.onload=function(){"js"===fileExt?eval(reader.result):_operation=JSON.parse(reader.result),UpdateOperationForm(1==files.length)},reader.readAsText(file)}}}